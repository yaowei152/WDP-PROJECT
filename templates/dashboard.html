{% extends "base.html" %}

{% block header %}
    Business Dashboard
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
    <div class="card-container">
        <div class="card">
            <h3>Total Invoices</h3>
            <div class="value">{{ total_invoices }}</div>
        </div>
        <div class="card">
            <h3>Total Revenue</h3>
            <div class="value">${{ "%.2f"|format(total_revenue) }}</div>
        </div>
        <div class="card">
            <h3>Paid Invoices</h3>
            <div class="value"><span style="color: #27ae60;">{{ paid_invoices }}</span></div>
        </div>
        <div class="card">
            <h3>Unpaid / Overdue</h3>
            <div class="value"><span style="color: #c0392b;">{{ unpaid_invoices }}</span></div>
        </div>
        <div class="card">
            <h3>Avg Processing Time</h3>
            <div class="value">{{ avg_proc_time }}</div>
        </div>
    </div>

    <div class="table-container">
        <h3 style="margin-bottom: 20px; color: #2c3e50;">Top Clients by Revenue (Table View)</h3>
        <table>
            <thead>
                <tr>
                    <th>Client Name</th>
                    <th>Total Invoiced Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for client in top_clients %}
                <tr>
                    <td>{{ client[0] }}</td>
                    <td>${{ "%.2f"|format(client[1]) }}</td>
                </tr>
                {% else %}
                <tr><td colspan="2">No data available yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 30px;">

        <div class="card" style="flex: 1 1 100%; box-sizing: border-box;">
            <h3 style="margin-bottom: 15px;">Invoiced: Reality vs Target Sales (Monthly)</h3>
            <div style="height: 300px;">
                <canvas id="invoicedBarChart"></canvas>
            </div>
        </div>

        <div style="flex: 1 1 300px; display: flex; flex-direction: column; gap: 20px;">
             <div class="card">
                 <h3>Orders YTD Status</h3>
                 <div style="height: 200px; display: flex; justify-content: center;">
                     <canvas id="ordersYtdChart"></canvas>
                 </div>
             </div>
             <div class="card">
                 <h3>Orders This Month Status</h3>
                 <div style="height: 200px; display: flex; justify-content: center;">
                     <canvas id="ordersMtdChart"></canvas>
                 </div>
             </div>
        </div>

        <div class="card" style="flex: 1 1 300px;">
             <h3 style="margin-bottom: 20px;">Top Clients (Revenue Progress)</h3>
             <div class="client-progress-list">
                 {% for item in top_clients_progress %}
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #555;">
                            <strong>{{ item.name }}</strong>
                            <span>${{ "%.2f"|format(item.amount) }}</span>
                        </div>
                        <div style="background-color: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div style="background-color: #3498db; height: 100%; border-radius: 5px; width: {{ item.percent }}%;"></div>
                        </div>
                    </div>
                 {% else %}
                 <p>No client data available for progress view.</p>
                 {% endfor %}
             </div>
        </div>

         <div class="card" style="flex: 1 1 400px;">
            <h3>Customer Satisfaction Trend</h3>
             <div style="height: 250px;">
                <canvas id="satisfactionChart"></canvas>
             </div>
        </div>
         <div class="card" style="flex: 1 1 400px;">
            <h3>Volume vs Service Level</h3>
             <div style="height: 250px;">
                <canvas id="volumeServiceChart"></canvas>
             </div>
        </div>
    </div>

    <script>
        // Helper for common chart options to match the clean wireframe style
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: {
                x: { grid: { display: false } },
                y: { grid: { color: '#f0f0f0' }, beginAtZero: true }
            }
        };

        // 1. Invoiced Bar Chart
        const ctxInvoice = document.getElementById('invoicedBarChart').getContext('2d');
        new Chart(ctxInvoice, {
            type: 'bar',
            data: {
                labels: {{ chart_invoice_months | tojson }},
                datasets: [
                    {
                        label: 'Reality Sales ($k)',
                        data: {{ chart_invoice_reality | tojson }},
                        backgroundColor: '#2ecc71', // Green
                        borderRadius: 5
                    },
                    {
                        label: 'Target Sales ($k)',
                        data: {{ chart_invoice_target | tojson }},
                        backgroundColor: '#f1c40f', // Yellow
                        borderRadius: 5
                    }
                ]
            },
            options: commonOptions
        });

        // Common options for Donut charts (no axes)
        const donutOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            cutout: '70%' // Makes it a donut instead of pie
        };

        // 2. Orders YTD Donut Chart
        const ctxYtd = document.getElementById('ordersYtdChart').getContext('2d');
        new Chart(ctxYtd, {
            type: 'doughnut',
            data: {
                labels: ['Achieved', 'Remaining'],
                datasets: [{
                    data: {{ chart_orders_ytd_pct | tojson }},
                    backgroundColor: ['#3498db', '#ecf0f1'],
                    borderWidth: 0
                }]
            },
            options: donutOptions
        });

        // 3. Orders MTD Donut Chart
        const ctxMtd = document.getElementById('ordersMtdChart').getContext('2d');
        new Chart(ctxMtd, {
            type: 'doughnut',
            data: {
                labels: ['Achieved', 'Remaining'],
                datasets: [{
                    data: {{ chart_orders_mtd_pct | tojson }},
                    backgroundColor: ['#e74c3c', '#ecf0f1'],
                    borderWidth: 0
                }]
            },
            options: donutOptions
        });

        // 4. Customer Satisfaction Area Chart
        const ctxSat = document.getElementById('satisfactionChart').getContext('2d');
        new Chart(ctxSat, {
            type: 'line',
            data: {
                labels: {{ chart_sat_labels | tojson }},
                datasets: [{
                    label: 'Satisfaction Score',
                    data: {{ chart_sat_data | tojson }},
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.2)', // Transparent fill
                    fill: true,
                    tension: 0.4 // Smooth curves
                }]
            },
            options: commonOptions
        });

        // 5. Volume vs Service Level Stacked Bar Chart
        const ctxVol = document.getElementById('volumeServiceChart').getContext('2d');
        new Chart(ctxVol, {
            type: 'bar',
            data: {
                labels: {{ chart_vol_service_labels | tojson }},
                datasets: [
                    {
                        label: 'Volume',
                        data: {{ chart_vol_data | tojson }},
                        backgroundColor: '#3498db',
                        borderRadius: 5
                    },
                    {
                        label: 'Services',
                        data: {{ chart_service_data | tojson }},
                        backgroundColor: '#2ecc71',
                        borderRadius: 5
                    }
                ]
            },
            options: {
                ...commonOptions,
                scales: {
                    x: { stacked: true, grid: { display: false } },
                    y: { stacked: true, grid: { color: '#f0f0f0' } }
                }
            }
        });
    </script>
{% endblock %}