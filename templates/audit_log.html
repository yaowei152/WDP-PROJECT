{% extends "base.html" %}

{% block header %}
    System Audit Log
{% endblock %}

{% block content %}

<style>
    /* ... (Styles remain the same as previous step) ... */
    
    /* Top Control Bar */
    .controls-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .section-title { font-size: 12px; font-weight: 700; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; }

    /* Filter Bar Container */
    .filter-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; gap: 10px; align-items: center; border: 1px solid #eee; }
    .search-input { flex: 1; padding: 10px 15px; border: 1px solid #dcdcdc; border-radius: 4px; font-size: 14px; }
    .action-select { width: 200px; padding: 10px; border: 1px solid #dcdcdc; border-radius: 4px; font-size: 14px; background-color: white; }

    /* Buttons */
    .btn-search { background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: 600; cursor: pointer; }
    .btn-search:hover { background-color: #2980b9; }
    .btn-reset { background-color: #7f8c8d; color: white; border: none; padding: 8px 15px; border-radius: 4px; font-size: 12px; font-weight: 600; text-decoration: none; }
    .btn-reset:hover { background-color: #95a5a6; }

    /* --- THE TABLE STYLE --- */
    .audit-table-container { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; }
    .audit-table { width: 100%; border-collapse: collapse; }
    .audit-table thead { background-color: #2c3e50; color: white; }
    .audit-table th { padding: 15px; text-align: left; font-size: 13px; font-weight: 600; border-bottom: none; }
    .audit-table td { padding: 15px; font-size: 14px; border-bottom: 1px solid #eee; color: #333; vertical-align: middle; }

    /* --- ROW HIGHLIGHTING --- */
    .row-standard { background-color: white; }
    .row-highlight { background-color: #fffbe6; border-left: 5px solid #f1c40f; }
    .row-highlight td:first-child { padding-left: 10px; }
    .row-red { background-color: #ffe6e6; border-left: 5px solid #ff4d4d; }
    .row-red td:first-child { padding-left: 10px; }

    /* Badges */
    .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
    .status-Success { background-color: #d4edda; color: #155724; }
    .status-Failure { background-color: #f8d7da; color: #721c24; }
    .status-Warning { background-color: #fff3cd; color: #856404; }
    .status-Danger { background-color: #f5c6cb; color: #721c24; }

    .btn-details { background-color: #3498db; color: white; padding: 5px 15px; border-radius: 4px; text-decoration: none; font-size: 12px; font-weight: bold; }
    .btn-details:hover { background-color: #2980b9; }
</style>

<div class="controls-header">
    <div class="section-title">Activity History</div>
    <a href="{{ url_for('audit_log') }}" class="btn-reset">Reset Filters</a>
</div>

<form method="GET" action="{{ url_for('audit_log') }}" class="filter-box">
    <input type="text" name="q" class="search-input" placeholder="Search (Timestamp, Action, User ID, Invoice ID...)" value="{{ request.args.get('q', '') }}">
    
    <select name="action_type" class="action-select">
        <option value="All">All Actions</option>
        {% for action in unique_actions %}
            <option value="{{ action }}" {% if request.args.get('action_type') == action %}selected{% endif %}>{{ action }}</option>
        {% endfor %}
    </select>

    <button type="submit" class="btn-search">Search</button>
</form>

<div class="audit-table-container">
    <table class="audit-table">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Actor</th>
                <th>Action</th>
                <th>Entity</th>
                <th>Status</th>
                <th>Description</th>
                <th>View</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr class="{% if 'Delete' in log.action or 'Suspended' in log.action or 'Wipe' in log.action %}row-red{% elif log.actor_type == 'SuperAdmin' %}row-highlight{% else %}row-standard{% endif %}">
                
                <td style="color: #666; width: 140px;">
                    {{ log.timestamp.strftime('%Y-%m-%d %H:%M') }}
                </td>
                
                <td>
                    <strong>{{ log.actor_type }}</strong><br>
                    <span style="font-size: 12px; color: #7f8c8d;">({{ log.actor_id }})</span>
                </td>
                
                <td style="font-weight: bold; color: #2c3e50;">
                    {{ log.action }}
                </td>
                
                <td>
                    <span style="color: #555;">{{ log.entity_type }}</span> 
                    <span style="font-size: 12px; color: #888;">#{{ log.entity_id }}</span>
                </td>
                
                <td>
                    <span class="status-badge status-{{ log.status }}">
                        {{ log.status }}
                    </span>
                </td>
                
                <td style="color: #555; max-width: 350px;">
                    {{ log.description }}
                </td>
                
                <td>
                    <a href="{{ url_for('audit_details', log_id=log.id) }}" class="btn-details">Details</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                    No audit records found.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}